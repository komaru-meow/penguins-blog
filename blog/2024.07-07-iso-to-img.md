---
authors: pieroproietti
slug: ancora-su-raspberry
title: "ancora su raspberry"
lang: it
enableComments: true
---

import Translactions from '@site/src/components/Translactions';

<Translactions />


# Creazione di una immagine raspberry custom

Nella puntata [precedente](./2024.07-07-ancora-su-raspberry.md) abbiamo visto come rimasterizzare una MicroSD per RaspberriPi, creando una immagine .img.

Possiamo fare questo a partire da una immagine ISO per arm64 creata con eggs su una VM arm64?

# Proviamo

Ho scaricato egg-of_debian-bookworm-naked_arm64_2024-04-14_1821.iso, la monto ed estraggo i file.

Sulla ISO ci sono 4 cartelle:
* grub
* efi
* isolinux
* live

Isolinux, qua non serve proprio, le altre due non sono sicuro. Quello che ci occorre è il contenuto di live:
* filesystem.squashfs
* initrd.img-6.1.0-20-arm64
* vmlinuz-6.1.0-20-arm64


In soldoni dalla partizione `bootfs` dovremmo far partire `vmlinux` che a sua volta utilizzerà `initrd-img`, questo dovrebbe montare quindi `filesystem.squashfs` come in effetti succede su una VM.

`filesystem.squashfs` è 469M, diciamo che con una immagina da 1G dovremmo avere spazio a sufficienza.

Andiamo a creare un raspi.img da 1G, suddiviso in due partizioni: bootfs e rootfs.

Per non sbagliare, partiremo da una immagine esistente e sicuramente funzionante.

# Scaricare immagine raspi 2024-07-04-raspios-bookworm-arm64-lite.img.xz

## decomprimere l'immagine
```
unxz 2024-07-04-raspios-bookworm-arm64-lite.img.xz -k
```
## Ridenominazione dell'immagine

```
mv 2024-07-04-raspios-bookworm-arm64-lite.img raspi.img
```
La nostra immagine root=PARTUUID=a3f161f3-02

```
sudo losetup -fP raspi.img
sudo losetup -a
```

## Ridimensionare la partizione
```
sudo kpartx -av /dev/loop1 # loop0 è usato dall'immagine ISO
```

troviamo:
```
add map loop1p1 (252:5): 0 1048576 linear 7:1 8192
add map loop1p2 (252:6): 0 4481024 linear 7:1 1056768
```

# montiamo rootfs
```
sudo mount /dev/mapper/loop1p2 /mnt/rootfs
```


# copiamo il tutto
```
sudo rsync -aAXv   /media/artisan/naked/live/ /mnt/rootfs/
```



# Andiamo a montare bootfs
```
sudo mount /dev/mapper/loop1p1 /mnt/bootfs
```


sostituiamo cmdline.txt con
```
console=serial0,115200 console=tty1 root=PARTUUID=a3f161f3-02 rootfstype=ext4 fsck.repair=yes rootwait quiet init=/vmlinuz-6.1.0-20-arm64
```

# smontiamo tutto
```
sudo umount /mnt/bootfs
sudo umount /mnt/rootfs
```


```
sudo kpartx -d /dev/loop1
```


A questo punt raspi.img dovrebbe essere pronta per essere registrata su usb


# Analizi initrd.img
Il nostro file initrd.img-6.1.0-20-arm64 è compresso con zstd, possiamo rilevarlo con il comando:
```
file initrd.img-6.1.0-20-arm64
```

A questo punto possiamo decomprimerlo:
```
zstd -d -k  initrd.img-6.1.0-20-arm64 -o initrd.img
```
Quindi creiamo una directory content per riversare i dati:
```
mkdir contents
cd contents
cpio -id < ../initrd.img
```





